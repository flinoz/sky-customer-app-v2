# .github/workflows/ci.yml

name: CI/CD Pipeline (Build and Test)

on:
  push:
    branches:
      - main
      - master # Si usas master como rama principal
  pull_request:
    branches:
      - main
      - master # Si usas master como rama principal

jobs:
  build-and-test:
    runs-on: ubuntu-latest # Ejecuta en un runner de Ubuntu

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3 # Descarga tu código

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9' # Asegúrate de que esta versión de Python sea la que necesitas

      - name: Install dependencies for Customer Service
        working-directory: ./customer_service # Ejecuta en el directorio del servicio de clientes
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install dependencies for Storage Service
        working-directory: ./storage_service # Ejecuta en el directorio del servicio de almacenamiento
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Paso para ejecutar las pruebas unitarias (si las tienes)
      # Adaptar según cómo ejecutes tus tests (ej. pytest)
      - name: Run Unit Tests (Customer Service)
        working-directory: ./customer_service
        run: |
          # Ejemplo: si usas pytest
          # pip install pytest
          # pytest
          echo "No unit tests configured for Customer Service. Skipping."

      - name: Run Unit Tests (Storage Service)
        working-directory: ./storage_service
        run: |
          # Ejemplo: si usas pytest
          # pip install pytest
          # pytest
          echo "No unit tests configured for Storage Service. Skipping."


      - name: Start Services and Run Integration Tests
        # Ejecuta desde la raíz del repositorio
        working-directory: . 
        run: |
          echo "Attempting to start Customer Service..."
          # Inicia customer_service en segundo plano
          nohup flask --app customer_service.app run --host=0.0.0.0 --port=5002 > customer_service.log 2>&1 &
          CUST_PID=$!
          echo "Customer Service PID: ${CUST_PID}"

          echo "Attempting to start Storage Service..."
          # Inicia storage_service en segundo plano
          nohup flask --app storage_service.app run --host=0.0.0.0 --port=5001 > storage_service.log 2>&1 &
          STOR_PID=$!
          echo "Storage Service PID: ${STOR_PID}"

          echo "Giving services time to start up..."
          sleep 10 # Dar más tiempo para asegurar que ambos servicios arranquen

          echo "--- Customer Service Log (Initial) ---"
          cat customer_service.log
          echo "--- Storage Service Log (Initial) ---"
          cat storage_service.log
          echo "-------------------------------------"

          # --- VERIFICACIÓN DE SALUD Y PRUEBAS DE INTEGRACIÓN ---
          
          echo "Checking Customer Service health endpoint (/saludo)..."
          HEALTH_CHECK_URL="http://127.0.0.1:5002/saludo"
          MAX_RETRIES=10
          RETRY_INTERVAL=3
          ATTEMPT=0
          
          until $(curl --output /dev/null --silent --head --fail ${HEALTH_CHECK_URL}); do
            if [ ${ATTEMPT} -eq ${MAX_RETRIES} ]; then
              echo "Customer Service failed to start after ${MAX_RETRIES} attempts."
              echo "--- Customer Service Log (Final) ---"
              cat customer_service.log
              echo "--- Storage Service Log (Final) ---"
              cat storage_service.log
              exit 1
            fi
            echo "Waiting for Customer Service to start... (Attempt ${ATTEMPT}/${MAX_RETRIES})"
            sleep ${RETRY_INTERVAL}
            ATTEMPT=$((ATTEMPT+1))
          done
          echo "Customer Service is up and running!"

          echo "Running basic integration tests..."

          # Prueba 1: Crear un cliente
          echo "Test 1: Creating a new client..."
          curl -X POST http://127.0.0.1:5002/clientes -H "Content-Type: application/json" -d '{"nombre": "John Doe", "contacto": "john.doe@example.com", "servicio": "Basic Plan"}'
          echo ""

          # Prueba 2: Obtener el cliente creado
          echo "Test 2: Getting the created client..."
          curl http://127.0.0.1:5002/clientes/John%20Doe
          echo ""

          # Prueba 3: Añadir un servicio al cliente
          echo "Test 3: Adding a service to the client..."
          curl -X POST http://127.0.0.1:5002/clientes/John%20Doe/servicios -H "Content-Type: application/json" -d '{"servicio": "Premium Add-on"}'
          echo ""

          # Prueba 4: Listar todos los clientes
          echo "Test 4: Listing all clients..."
          curl http://127.0.0.1:5002/clientes
          echo ""

          # Prueba 5: Eliminar el cliente (opcional, para limpieza o test de eliminación)
          echo "Test 5: Deleting the client..."
          curl -X DELETE http://127.0.0.1:5001/archivos/John%20Doe
          echo ""
          
          echo "All integration tests completed."

        env:
          CI_CD_ENV: 'true' # <-- ESTO ES CLAVE para tu 'storage_service/app.py'

      - name: Kill Flask processes (Optional cleanup)
        # Este paso es más una buena práctica; el runner se destruirá de todos modos
        if: always() # Ejecutar siempre, incluso si los pasos anteriores fallan
        run: |
          echo "Attempting to kill Flask processes..."
          # Intenta matar los procesos por PID si fueron almacenados
          if [ -n "${CUST_PID}" ]; then kill ${CUST_PID}; fi
          if [ -n "${STOR_PID}" ]; then kill ${STOR_PID}; fi
          # También puedes intentar por nombre si los PID no están disponibles o fallan
          # pkill -f "flask run" || true
          echo "Cleanup complete."